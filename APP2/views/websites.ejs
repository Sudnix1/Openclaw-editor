<!-- views/websites.ejs - Enhanced with employee access display -->
<div class="container-fluid mt-4">
  <div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center bg-light">
      <h3 class="mb-0"><i class="bi bi-globe2 me-2"></i>Website Management</h3>
      <div>
        <a href="/" class="btn btn-outline-secondary me-2">
          <i class="bi bi-house"></i> Dashboard
        </a>
        <a href="/websites/add" class="btn btn-primary">
          <i class="bi bi-plus-lg"></i> Add Website
        </a>
      </div>
    </div>
    <div class="card-body">
      <% if (locals.successMessage) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill me-2"></i> <%= successMessage %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <% if (locals.errorMessage) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> <%= errorMessage %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <% if (websites && websites.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th style="width: 20%">Website</th>
                <th style="width: 15%">URL</th>
                <th style="width: 15%">WordPress</th>
                <th style="width: 10%">Created</th>
                <th style="width: 25%">Employee Access</th>
                <th style="width: 15%" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% websites.forEach(website => { %>
                <tr class="<%= locals.currentWebsiteId === website.id ? 'table-active' : '' %>">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="website-icon me-2 d-flex align-items-center justify-content-center bg-light rounded-circle" style="width: 40px; height: 40px;">
                        <i class="bi bi-globe text-primary"></i>
                      </div>
                      <div>
                        <div class="fw-bold"><%= website.name %></div>
                        <% if (locals.currentWebsiteId === website.id) { %>
                          <span class="badge bg-success">Current</span>
                        <% } %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <% if (website.url) { %>
                      <a href="<%= website.url %>" target="_blank" class="text-decoration-none">
                        <%= website.url %>
                        <i class="bi bi-box-arrow-up-right text-muted ms-1 small"></i>
                      </a>
                    <% } else { %>
                      <span class="text-muted fst-italic">Not set</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (website.wordpress_api_url) { %>
                      <span class="badge bg-success p-2">
                        <i class="bi bi-wordpress me-1"></i> Connected
                      </span>
                    <% } else { %>
                      <span class="badge bg-danger p-2">
                        <i class="bi bi-x-circle me-1"></i> Not Connected
                      </span>
                    <% } %>
                  </td>
                  <td><%= new Date(website.created_at).toLocaleDateString() %></td>
                  <td>
                    <!-- Employee access summary -->
                    <div class="employee-access">
                      <!-- Note: This section requires modifications to your route handler.
                           You need to fetch employee permissions data when listing websites. -->
                      
                      <!-- If we have permissions data available -->
                      <% if (website.employeeAccess) { %>
                        <% if (website.employeeAccess.length === 0) { %>
                          <span class="text-muted fst-italic">No employees have access</span>
                        <% } else { %>
                          <div class="d-flex flex-wrap gap-1">
                            <% website.employeeAccess.forEach(employee => { %>
                              <span class="badge bg-info text-dark me-1">
                                <%= employee.name %>
                              </span>
                            <% }); %>
                          </div>
                        <% } %>
                      <% } else { %>
                        <!-- Show a link to manage permissions if data not available -->
                        <a href="/websites/permissions/<%= website.id %>" class="btn btn-sm btn-outline-info">
                          <i class="bi bi-people me-1"></i> Manage Permissions
                        </a>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex justify-content-center gap-1">
                      <div class="btn-group" role="group">
                        <a href="/websites/edit/<%= website.id %>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit Website">
                          <i class="bi bi-pencil-square"></i>
                        </a>
                        
                        <button type="button" class="btn btn-sm btn-outline-info duplicate-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#duplicateModal"
                                data-website-id="<%= website.id %>"
                                data-website-name="<%= website.name %>"
                                title="Duplicate Website with Settings">
                          <i class="bi bi-copy"></i>
                        </button>
                        
                        <% if (locals.currentWebsiteId !== website.id) { %>
                          <form action="/websites/switch" method="POST" class="d-inline">
                            <input type="hidden" name="websiteId" value="<%= website.id %>">
                            <input type="hidden" name="returnUrl" value="/websites">
                            <button type="submit" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Switch to this Website">
                              <i class="bi bi-check2-circle"></i>
                            </button>
                          </form>
                          
                          <% if (websites.length > 1) { %>
                            <form action="/websites/delete/<%= website.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this website? This will NOT delete your data.');">
                              <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete Website">
                                <i class="bi bi-trash"></i>
                              </button>
                            </form>
                          <% } %>
                        <% } else { %>
                          <!-- Current website placeholder button -->
                          <button type="button" class="btn btn-sm btn-outline-success active" disabled data-bs-toggle="tooltip" title="Current Website">
                            <i class="bi bi-check2-all"></i>
                          </button>
                        <% } %>
                        
                        <a href="/websites/permissions/<%= website.id %>" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="Manage Permissions">
                          <i class="bi bi-people"></i>
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div class="alert alert-info d-flex align-items-center">
          <i class="bi bi-info-circle-fill me-2 fs-4"></i>
          <div>
            <p class="mb-0">No websites have been set up yet. Click the "Add Website" button to create your first website.</p>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Duplicate Website Modal -->
<div class="modal fade" id="duplicateModal" tabindex="-1" aria-labelledby="duplicateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-light" id="duplicateModalLabel">
          <i class="bi bi-copy me-2"></i>Duplicate Website
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Duplicate Website:</strong> This will create a new website with all settings copied from the original website, including prompts, Discord configuration, and other settings.
        </div>
        
        <form id="duplicateForm" action="/websites/duplicate" method="POST">
          <input type="hidden" id="sourceWebsiteId" name="sourceWebsiteId" value="">
          
          <div class="mb-3">
            <label for="duplicateName" class="form-label text-light">New Website Name</label>
            <input 
              type="text" 
              class="form-control" 
              style="background-color: var(--dark-card); color: var(--text-input); border: 1px solid var(--border-color);"
              id="duplicateName" 
              name="name" 
              placeholder="Enter name for the new website" 
              required>
            <div class="form-text text-muted">The new website will have all the same settings as the original.</div>
          </div>
          
          <div class="mb-3">
            <label for="duplicateUrl" class="form-label text-light">New Website URL (Optional)</label>
            <input 
              type="url" 
              class="form-control" 
              style="background-color: var(--dark-card); color: var(--text-input); border: 1px solid var(--border-color);"
              id="duplicateUrl" 
              name="url" 
              placeholder="https://example.com">
            <div class="form-text text-muted">You can change this later in website settings.</div>
          </div>
          
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Note:</strong> The duplicated website will copy all settings but will not copy existing content (recipes, keywords, etc.).
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary text-light" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="duplicateForm" class="btn" style="background-color: var(--accent-teal); color: var(--text-light);">
          <i class="bi bi-copy me-2"></i>Duplicate Website
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Initialize tooltips and duplicate functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
  
  // Add modal event handler to populate form when modal is shown
  document.addEventListener('DOMContentLoaded', function() {
    const duplicateModal = document.getElementById('duplicateModal');

    if (duplicateModal) {
      // When modal is about to be shown, populate the form
      duplicateModal.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        const button = event.relatedTarget;

        if (button) {
          const websiteId = button.getAttribute('data-website-id');
          const websiteName = button.getAttribute('data-website-name');

          console.log('üìã Preparing duplicate for:', websiteId, websiteName);

          // Populate the form fields
          document.getElementById('sourceWebsiteId').value = websiteId;
          document.getElementById('duplicateName').value = websiteName + ' (Copy)';
          document.getElementById('duplicateUrl').value = '';

          console.log('‚úÖ Source Website ID set to:', websiteId);
          console.log('‚úÖ Duplicate Name set to:', websiteName + ' (Copy)');
        }
      });
    }

    // Add form submission handler to debug
    const duplicateForm = document.getElementById('duplicateForm');
    if (duplicateForm) {
      duplicateForm.addEventListener('submit', function(e) {
        const sourceId = document.getElementById('sourceWebsiteId').value;
        const name = document.getElementById('duplicateName').value;

        console.log('üì§ Form submitting with:');
        console.log('   Source Website ID:', sourceId);
        console.log('   New Name:', name);

        if (!sourceId || !name) {
          e.preventDefault();
          alert('‚ö†Ô∏è Please fill in all required fields:\n\n' +
                (!sourceId ? '- Source website is missing\n' : '') +
                (!name ? '- New website name is required\n' : ''));
          return false;
        }
      });
    }
  });
</script>